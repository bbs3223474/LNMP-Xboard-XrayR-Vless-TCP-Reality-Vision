# LNMP-Xboard-XrayR-Vless-TCP-Reality-Vision
基于LNMP环境，不依赖aaPanel、1Panel等自动化平台，部署XBoard面板和XrayR后端，并采用Vless+TCP+Reality+xTLS-rprx-vision方案创建节点，同时不占用443端口以便正常搭建网站的教程。

## UPDATE 2025/04/13
在编写本篇教程的时候，我个人的前端和节点也正式部署完毕了。理论上说，最理想状态下的Vless+Reality+Vision的延迟和速度是非常好看的。比如我基于亚马逊Lightsail服务器搭建的一个Vless节点就能跑到几近500Mbps的水平，远超出Vmess时期的速度。

然而，实际上线测试的时候却得到相当多负面的反馈，比如手机无法连接、Shadowrocket测试超时、网速只有几百KB、DMM页游都打不开等等。经过我在Lightsail、阿里云、樱花等多个VPS提供商，按照相同条件搭建节点后测试对比发现，该方案的稳定性实在是难以捉摸，甚至会严重影响节点速度（比如樱花服务器给了100Mbps带宽，搭建节点后测速却只有10Mbps甚至更低）。有时候电脑很快手机却几乎无法使用；有时候电脑手机都可以，但换个运营商就连接超时，即便是反复更换Reality所“偷”的域名也无济于事。

鉴于上述情况，虽然目前Reality是理论上最为安全的协议之一，但考虑到稳定性和速度问题，我个人最终还是在节点上线的第一天就弃用了这个方案，转为使用Hysteria2后端。虽然速度会比服务器标称带宽慢一些（目前测得樱花服务器跑在80-90Mbps，相比标称的100Mbps偏低，比Vmess方案都低一点，但延迟还是比较好看的，能控制在80-100ms），但对比起Vless来说，显然还是这个方案更加现实。

本篇教程依旧会完整呈现所有的搭建步骤，供大家参考。但如果各位的节点也遇到上述的问题，可能还是需要像我一样考虑更换方案。当然，如果你有什么好的建议，也欢迎提出Issue，大家共同测试、讨论。

## 简介
近期，原先比较受欢迎的Vmess+Websocket+TLS协议已经大范围中招，均表现为SSL端口被封。原先换个端口还能继续用一段时间，但近期已经严重到几乎是今天上午刚改好，晚上就封掉。如此速度已经无法正常使用节点，所以需要探索更稳定可靠的节点搭建方式。

经过研究，发现可能是传统的Vmess+TLS会产生TLS in TLS的问题（我也不知道啥意思），然后前5个数据包会存在明显的固定特征。目前来看，可能就是通过识别这些特征使得这类节点的SSL端口能被快速封禁。又经过查询，似乎使用Vless+Reality+xTLS-rprx-vision流控是一个很不错的解决方案。首先Vless不依赖系统时间和Alter ID，其次Reality使得我们不再需要大费周章申请和续期证书（虽然也不难），而是可以直接从一个公开、正常的网站上“偷”证书，据说伪装效果更好，最后就是xTLS-rprx-vision解决了上述5个数据包的问题，让流量特征更干净。

然而，按照以往我的服务器搭建方式，即SSPanel-Uim+LNMP+XrayR，存在一个明显的问题：SSPanel不支持Vless节点的订阅。不确定是不是我的版本比较老，总之考虑到SSPanel目前的复杂程度、维护难度和各种各样的小问题，我还是决定寻找一个能正常添加和订阅Vless节点的前段面板。经过几番搜寻，发现XBoard是个不错的解决方案。XBoard是V2Board停更后其他人维护的作品，虽然界面简陋了点，但该它能做的它都能做，现在也已经实现了完全的Docker容器部署，完全不需要你再费尽心思改什么.config.php之类乱七八糟的文件，后续的升级、迁移整合等等操作都可以一个命令搞定，相当方便。

当然了，实际操作了一遍以后才发现，事情并没有想象的那么简单。XBoard的Wiki文档除了安装和迁移以外基本啥都不说，老V2Board的文档内容跟不上时代，XrayR的文档大差不差，看网络上的教程也非常的零散，经常只说半句话，或者他们使用的软件、协议组合并不完全符合我的要求……这些东西应该怎么配置？XBoard安装完成后默认用的IP地址+端口访问，怎么样才能把它绑到我想要的域名上？怎么才不需要记那串奇奇怪怪的链接就能访问管理员面板？配置文件怎么写才能让前后端对接上？很多很多问题会一下子就涌现出来，相当头疼。但无论如何，经过几个日夜的头疼以后，我也算终于摸出门路了。在这里也希望给大家一个一站式的解决方案，从刚买服务器，到订阅好节点，我希望能够一口气帮到大家，而不需要再去到处翻找教程。

## 重要声明
1、本篇教程内容将会非常小白，因为我个人也不是研究这东西的，基本上就是一个看得懂英语的文科生在到处复制粘贴，所以为了让更多像我一样的人也能自己动手搭建，正文内容会存在较多高手看起来很啰嗦的内容。

2、本文旨在为需要无偿或在不产生利润的前提下，将节点分享给周围可信任的亲朋好友使用的人群，建立一个图形化、可视化和统一化的管理平台。本文绝不提倡通过建立机场出租节点赚取利润的行为，同时也不推荐将节点组借给陌生人。我自己面板里所有付费了的用户，一年加起来的费用也无法抵扣我半年租用服务器的花销。因此请维护好底线思维，关键不在于你是否搭了梯子，而是在于你是否借此盈利，以及你本人或其他使用者是否发布了违反法律的内容。

3、本文将基于Ubuntu 22.04/24.04系统进行编写，并默认你已处在root账户下。若不希望或无法使用root账户操作的，请自行添加sudo命令，本文不再赘述。

4、本文将默认你已经申请域名并设置好解析记录，本文将不会提及域名申请的问题，请自行根据自己所在的平台查找相关教程，或阅读官方文档。

## 本教程适用的搭建需求
1、使用LNMP一键安装包或自行安装Nginx、MySQL（MariaDB）和PHP进行前段面板的搭建（本教程以LNMP一键安装包2.2为准）。

2、前端面板安装好后，需要将IP地址绑定（反代）到申请好的域名上。

3、后端XrayR在对接时，不占用443端口，以便在服务器上搭建其他网站。

4、不依赖XrayR管理Reality信息，而是用面板进行数据下发。

5、确保PC端使用V2RayN、手机端使用Shadowrocket和V2rayNG能够正常获得订阅内容。

## 正文
### 一、初步准备服务器
#### 1、安装可能有用的软件包

分别输入以下命令：
```
apt-get update
apt install vim nano wget git curl net-tools socat
```
当然，个人更推荐使用类似FinalShell那样自带文本编辑器的SSH客户端，毕竟鼠标直接操作要容易、直观太多了。这个是个人喜好，请自行选择是否使用。

#### 2、更换内核并调整拥塞算法

（可选）输入以下命令导入GPG Key:
```
apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 86F7D09EE734E623
```
否则接下来安装Xanmod内核时会提示没有key，导致安装失败。如果你不需要使用Xanmod内核，则无需此步。注意：在Ubuntu 24.04系统上使用该命令会提示命令已过时，但不影响正常执行。

输入以下命令安装一键加速脚本（在此感谢原作者）：
```
wget -N --no-check-certificate "https://github.000060000.xyz/tcpx.sh" && chmod +x tcpx.sh && ./tcpx.sh
```
自动执行后，根据需要选择你想安装的内核，个人喜欢使用Xanmod (main)，内核版本更新，细节优化会更好一些。

安装好内核后，输入reboot重启服务器，重新连接上后，再次执行tcpx.sh脚本：
```
./tcpx.sh
```
然后选择你喜欢的拥塞算法。根据用户和服务器的地理位置、服务器性能、系统、网络线路等因素，不同的拥塞算法表现不尽相同，需要你自己反复测试。个人的选择是bbr+fq_pie。

脚本中其他的优化方案请自行探究，如关闭ECN、打开IPv6等。注意：部分VPS提供商打开IPv6的方法可能与公版系统的不相同（如樱花），你需要查阅VPS提供商的说明文档来进行操作，这里不再赘述。

#### 3、设置Swap虚拟内存

大多数VPS提供商并未在创建实例时提供Swap分区，如果你的服务器配置不够高，尤其是内存不够大，则有可能会在后续编译LNMP时因内存不足报错退出。所以这里推荐增加一个：
```
dd if=/dev/zero of=/var/swapfile bs=1024 count=3072000 && mkswap /var/swapfile && chmod -R 0600 /var/swapfile && swapon /var/swapfile && echo "/var/swapfile swap swap defaults 0 0" >> /etc/fstab
```
该命令会在/dev文件夹下创建一个名为swapfile的文件，大约3GB，生成后即为虚拟内存空间。

#### 4、关闭防火前

输入以下命令尝试关闭防火墙：
```
systemctl stop iptables
systemctl disable iptables
systemctl stop firewalld
systemctl disable firewalld
```
在安全性要求较低、不想老是麻烦自己去添加各种端口、放行IP的情况下，直接关闭防火墙是最方便的选择。注意：部分VPS提供商不仅会在实例管理面板上提供诸如“防火墙”、“安全组”、“数据包过滤”等功能，还会在系统里启动iptables或firewalld来进行“二次防火”（比如亚马逊Lightsail），所以在设置完提供商自己的防火墙后，还需要手动在操作系统里关闭。

#### 5、（可选）低配置VPS内存、Swap性能的优化

部分低配置VPS（如阿里云轻量化）存在内存明明虚标严重（标称1GB实际可用只有700MB），Swap利用率却始终为0的情况，导致就连apt-get upgrade这样的操作都能把整个系统卡死，后续编译lnmp更是无稽之谈。我们可以通过以下命令查看：
```
cat /proc/sys/vm/swappiness
```
如果返回的结果为0，则证明系统上的Swap分区利用率始终为0%。这对于小内存VPS来说非常不合理，因此我们可以通过修改系统参数来进行优化。
```
vim /etc/sysctl.conf
```
在文件内，我们可能会发现诸如下述的内容：
```
（前略）
###################################################################
# Magic system request Key
# 0=disable, 1=enable all, >1 bitmask of sysrq functions
# See https://www.kernel.org/doc/html/latest/admin-guide/sysrq.html
# for what other values do
#kernel.sysrq=438

fs.file-max=65535
fs.file-max=65535
fs.file-max=65535
```
如果我们翻遍了整个文件都没发现关于swappiness相关的语句，那这时候我们就可以在文件末尾手动添加如下内容：
```
vm.dirty_background_ratio = 5
vm.dirty_ratio = 10
vm.swappiness = 10
vm.dirty_expire_centisecs = 1500
vm.dirty_writeback_centisecs = 500
```
保存以后，重启VPS。

以上是常见的通用优化方案，如果你发现sysctl.conf里面已经有类似的语句，可以直接对数值进行修改。如果你希望最大程度发挥物理内存和Swap的性能，你可以参照网上的教程进行调整。但通过上述修改，已经可以做到让系统主动调用Swap，但又尽量确保优先使用物理内存了。

备注：大多数VPS即使不用这样设置，也能够主动调用Swap。通常来说，只有当你发现编译lnmp严重卡顿、添加了3GB的swap依旧会报Error 1错误时，才需要手动修改配置策略。目前仅在阿里云轻量化服务器上发现此类问题。

### 二、安装LNMP
#### 1、修改lnmp.conf添加Nginx Preread模块

为了实现后续“不与443端口冲突”的功能，我们必须要在安装LNMP前设置好Nginx额外安装的模块。

首先输入以下命令下载LNMP一键安装包（以2.2版本为例）
```
mkdir lnmp
cd lnmp
wget https://soft.lnmp.com/lnmp/lnmp2.2.tar.gz -O lnmp2.2.tar.gz && tar zxf lnmp2.2.tar.gz
```
2.2版本的一键安装包很明显作者是用的Mac电脑打包的，因此在Linux环境下解压会报一大堆跟苹果系统有关的错误，这个不影响正常解压，无需理会。但如果你直接按照lnmp.org上的命令执行，会发现根本进行不到开始安装那一步。因此我们要手动创建lnmp文件夹，然后再进去手动执行install.sh。

之后修改lnmp.conf
```
vim lnmp.conf
```
找到Nginx_Modules_Options语句（约第3行）并按照如下内容进行修改：
```
Nginx_Modules_Options='--with-stream_ssl_preread_module'
```
保存退出脚本，执行LNMP安装：
```
./install.sh lnmp
```
